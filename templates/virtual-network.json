{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "natGatewayName": { "type": "string" },
      "firewallName": { "type": "string" },
      "vnetName": { "type": "string" },
      "armVnetAddressSpaceCIDR": { "type": "string" },
      "subnet1Name": { "type": "string" },
      "subnet1Prefix": { "type": "string" },
      "subnet2Name": { "type": "string" },
      "subnet2Prefix": { "type": "string" },
      "firewallPolicy1Name": { "type": "string" },
      "firewallPolicy2Name": { "type": "string" },
      "location": { "type": "string" },
      "natGatewayPublicIP": { "type": "string", "metadata": { "description": "Public IP address (e.g., 10.20.30.40)" } },
      "FirewallPublicIP": { "type": "string", "metadata": { "description": "Public IP address (e.g., 10.20.30.40)" } }
    },
    "resources": [
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2021-04-01",
        "name": "VNetDeployment",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "https://raw.githubusercontent.com/SkillsFundingAgency/das-hub-infrastructure/main/templates/virtual-network.json",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "armVnetName": { "value": "[parameters('vnetName')]" },
            "armVnetAddressSpaceCIDR": { "value": "[parameters('armVnetAddressSpaceCIDR')]" }
          }
        }
      },
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2021-04-01",
        "name": "NatGatewayDeployment",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "https://raw.githubusercontent.com/SkillsFundingAgency/das-hub-infrastructure/main/templates/nat_gateway.json",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "natGatewayName": { "value": "[parameters('natGatewayName')]" },
            "location": { "value": "[parameters('location')]" },
            "publicIp": { "value": "[parameters('natGatewayPublicIP')]" }
          }
        }
      },
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2021-04-01",
        "name": "SubnetUpdateDeployment",
        "dependsOn": [ "NatGatewayDeployment" ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "https://raw.githubusercontent.com/SkillsFundingAgency/das-hub-infrastructure/main/templates/subnet.json",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "virtualNetworkName": { "value": "[parameters('vnetName')]" },
            "subnetName": { "value": "[parameters('subnet1Name')]" },
            "subnetAddressPrefix": { "value": "[parameters('subnet1Prefix')]" },
            "natGatewayIp": { "value": "[parameters('natGatewayPublicIP')]" },
            "serviceEndpointList": { "value": [] },
            "delegations": { "value": [] },
            "routeTable": { "value": {} },
            "networkSecurityGroup": { "value": {} }
          }
        }
      },
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2021-04-01",
        "name": "FirewallPoliciesDeployment",
        "dependsOn": [ "VNetDeployment" ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "https://raw.githubusercontent.com/SkillsFundingAgency/das-hub-infrastructure/main/templates/firewall_policies.json",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "firewallPolicies": { 
              "value": [
                { "name": "[parameters('firewallPolicy1Name')]" },
                { "name": "[parameters('firewallPolicy2Name')]" }
              ]
            },
            "location": { "value": "[parameters('location')]" }
          }
        }
      },
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2021-04-01",
        "name": "AzureFirewallDeployment",
        "dependsOn": [ "NatGatewayDeployment", "FirewallPoliciesDeployment", "VNetDeployment" ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "https://raw.githubusercontent.com/SkillsFundingAgency/das-hub-infrastructure/main/templates/azure_firewall.json",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "firewallName": { "value": "[parameters('firewallName')]" },
            "location": { "value": "[parameters('location')]" },
            "firewallSubnetId": { "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name'))]" },
            "firewallPublicIp": { "value": "[parameters('FirewallPublicIP')]" },
            "firewallPolicyId": { "value": "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicy1Name'))]" }
          }
        }
      }
    ]
  }